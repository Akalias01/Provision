<?xml version="1.0" encoding="utf-8"?>
<!--
    LITHOS - Audiobook Player Application

    Features:
    - M4B, MP3, and audio file playback
    - Android Auto integration with content hierarchy
    - Media notification with playback controls
    - Series management with grouping and sorting
    - OpenLibrary integration for series metadata
    - "Not in Library" section showing missing books with covers
    - Synopsis fetching for individual books
    - Related content display (comics, companions, graphic novels)
    - Long-press to remove books with confirmation
    - Tap covers to view synopsis dialogs
    - Manual refresh for series metadata cache
    - Book exclusion from series suggestions
    - Cover art extraction and display
    - Sleep timer and playback speed controls
    - Chapter navigation
-->
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />

    <!-- TTS Visibility for Android 11+ (kept for accessibility/preview) -->
    <queries>
        <intent>
            <action android:name="android.intent.action.TTS_SERVICE" />
        </intent>
        <!-- Android Auto MediaBrowserService visibility for API 30+ -->
        <intent>
            <action android:name="android.media.browse.MediaBrowserService" />
        </intent>
    </queries>

    <application
        android:name=".LithosApp"
        android:icon="@mipmap/ic_launcher"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:label="@string/app_name"
        android:theme="@style/Theme.Lithos"
        android:allowBackup="true"
        android:supportsRtl="true"
        android:requestLegacyExternalStorage="true"
        android:localeConfig="@xml/locales_config">

        <!-- Android Auto support -->
        <meta-data
            android:name="com.google.android.gms.car.application"
            android:resource="@xml/automotive_app_desc" />

        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:theme="@style/Theme.Lithos">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>

            <!-- Handle magnet: links from browser/other apps -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="magnet" />
            </intent-filter>

            <!-- Handle .torrent files -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <data android:mimeType="application/x-bittorrent" />
            </intent-filter>

            <!-- Handle audio files -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <data android:mimeType="audio/*" />
            </intent-filter>

            <!-- Handle M4B audiobook files specifically -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="content" />
                <data android:scheme="file" />
                <data android:host="*" />
                <data android:pathPattern=".*\.m4b" />
                <data android:mimeType="*/*" />
            </intent-filter>
        </activity>

        <!--
        LithosPlaybackService: Media3 playback service for foreground notification.
        Android Auto browsing handled by LithosMediaService below.
        -->
        <service
            android:name=".service.LithosPlaybackService"
            android:foregroundServiceType="mediaPlayback"
            android:exported="true">
            <intent-filter>
                <action android:name="androidx.media3.session.MediaLibraryService" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>

            <!-- Media button receiver -->
            <intent-filter>
                <action android:name="android.intent.action.MEDIA_BUTTON" />
            </intent-filter>
        </service>

        <!--
        LithosMediaService: Production-grade Android Auto integration.
        Provides full MediaBrowserServiceCompat with:
        - Content hierarchy (Now Playing, Library, Favorites, By Author, By Series)
        - Dynamic album art with bitmap resizing (max 512x512)
        - Animated equalizer bars support
        - Voice search
        - Audio focus management
        -->
        <service
            android:name=".service.LithosMediaService"
            android:foregroundServiceType="mediaPlayback"
            android:exported="true">
            <intent-filter>
                <action android:name="android.media.browse.MediaBrowserService" />
            </intent-filter>
        </service>

        <!-- FileProvider for Android Auto cover art content:// URIs -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
    </application>
</manifest>
